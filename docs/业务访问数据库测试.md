```bash
$ sudo service mysql status  # wsl 下 查看 mysql 状态
$ sudo service mysql start
```



## 注册 v0.8.1

```mysql
# 数据库
$ mysql -u root -p #123456
mysql> use chat;

mysql> select * from user;
Empty set (0.01 sec)

mysql> select * from user;
+----+-----------+----------+---------+
| id | name      | password | state   |
+----+-----------+----------+---------+
| 22 | zhang san | 123456   | offline |
+----+-----------+----------+---------+
1 row in set (0.00 sec)
```

```bash
# 服务端
build$ ../bin/ChatServer 
20230606 10:55:54.531036Z  1695 INFO  TcpServer::newConnection [ChatServer] - new connection [ChatServer-127.0.0.1:6000#1] from 127.0.0.1:43110 - TcpServer.cc:80
{"msgid":4,"name":"zhang san","password":"123456"}

20230606 10:58:00.783960Z  1696 INFO  connect mysql success! - db.cpp:28
```



```bash
# 客户端
$ telnet 127.0.0.1 6000
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
{"msgid":4,"name":"zhang san","password":"123456"}  # 注册
{"errno":0,"id":22,"msgid":5}
```

---

## 登录 v0.8.2

```bash
# 服务端
$ ../bin/ChatServer 
20230606 12:03:54.543215Z  2772 INFO  TcpServer::newConnection [ChatServer] - new connection [ChatServer-127.0.0.1:6000#1] from 127.0.0.1:43154 - TcpServer.cc:80
{"msgid":1,"id":22,"password":"123456"}

20230606 12:03:57.031279Z  2773 INFO  connect mysql success! - db.cpp:28
20230606 12:03:57.055196Z  2773 INFO  connect mysql success! - db.cpp:28
```

```bash
# 客户端
$ telnet 127.0.0.1 6000
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
{"msgid":1,"id":22,"password":"123456"}
{"errno":0,"id":22,"msgid":2,"name":"zhang san"}
```

```mysql
# 数据库
$ mysql -u root -p #123456
mysql> use chat;
mysql> select * from user;  # 在线状态更新为 online 了
+----+-----------+----------+--------+
| id | name      | password | state  |
+----+-----------+----------+--------+
| 22 | zhang san | 123456   | online |
+----+-----------+----------+--------+
1 row in set (0.00 sec)

mysql> update user set state = 'offline' where id=22;  # 手动将其下线

mysql> select * from user;
+----+-----------+----------+---------+
| id | name      | password | state   |
+----+-----------+----------+---------+
| 22 | zhang san | 123456   | offline |
+----+-----------+----------+---------+
1 row in set (0.00 sec)
```



```bash
{"msgid":1,"id":22,"password":"123456"}  # 登录
```

调试

```bash
gdb ChatServer
(gdb) break chatservice.cpp:41
(gdb) run
(gdb) n
(gdb) p id
```

## 客户端异常退出 v0.8.4

```bash
# 服务端
$ ../bin/ChatServer
20230606 13:01:26.984051Z  7214 INFO  TcpServer::newConnection [ChatServer] - new connection [ChatServer-127.0.0.1:6000#1] from 127.0.0.1:43212 - TcpServer.cc:80

20230606 13:03:30.759842Z  7216 INFO  connect mysql success! - db.cpp:28
20230606 13:03:30.767109Z  7216 INFO  connect mysql success! - db.cpp:28

20230606 13:05:43.445886Z  7216 INFO  connect mysql success! - db.cpp:28

20230606 13:05:43.464420Z  7214 INFO  TcpServer::removeConnectionInLoop [ChatServer] - connection ChatServer-127.0.0.1:6000#2 - TcpServer.cc:109
```

```bash
# 客户端
$ telnet 127.0.0.1 6000
{"msgid":1,"id":22,"password":"123456"}  # 去数据库查看

# 退出 按 ctrl + ] 再按 enter
^]

telnet> quit
# 再去数据库查看
```

```mysql
# 数据库
mysql> select * from user;
+----+-----------+----------+--------+
| id | name      | password | state  |
+----+-----------+----------+--------+
| 22 | zhang san | 123456   | online |
+----+-----------+----------+--------+
1 row in set (0.00 sec)

> select * from user;
+----+-----------+----------+---------+
| id | name      | password | state   |
+----+-----------+----------+---------+
| 22 | zhang san | 123456   | offline |
+----+-----------+----------+---------+
1 row in set (0.00 sec)
```

## 一对一聊天 v0.8.5

```bash
# 服务端
$ ../bin/ChatServer

# 张三连接
20230607 05:56:59.223160Z 20197 INFO  TcpServer::newConnection [ChatServer] - new connection [ChatServer-127.0.0.1:6000#1] from 127.0.0.1:43360 - TcpServer.cc:80

# 张三 登录
{"msgid":1,"id":22,"password":"123456"}

20230607 05:57:42.247577Z 20198 INFO  connect mysql success! - db.cpp:28
20230607 05:57:42.269950Z 20198 INFO  connect mysql success! - db.cpp:28

# 李四连接
20230607 05:58:13.799089Z 20197 INFO  TcpServer::newConnection [ChatServer] - new connection [ChatServer-127.0.0.1:6000#2] from 127.0.0.1:43366 - TcpServer.cc:80

# 李四注册
{"msgid":4,"name":"li si","password":"666666"}

20230607 05:58:35.482768Z 20199 INFO  connect mysql success! - db.cpp:28

# 李四登录
{"msgid":1,"id":23,"password":"666666"}

20230607 06:00:01.845439Z 20199 INFO  connect mysql success! - db.cpp:28
20230607 06:00:01.851806Z 20199 INFO  connect mysql success! - db.cpp:28
```

```bash
# 客户端 张三登录
$ telnet 127.0.0.1 6000
{"msgid":1,"id":22,"password":"123456"}  # 张三登录
{"errno":0,"id":22,"msgid":2,"name":"zhang san"}  # 服务器发送正确登录消息

{"msgid":6,"id":22,"from":"zhang san","to":23,"msg":"hello!"}  # 张三给李四发消息
```

```bash
# 客户端 李四 注册登录
$ telnet 127.0.0.1 6000
{"msgid":4,"name":"li si","password":"666666"}  # 李四注册
{"errno":0,"id":23,"msgid":5}  # 服务器发送李四注册成功消息

{"msgid":1,"id":23,"password":"666666"}  # 李四登录
{"errno":0,"id":23,"msgid":2,"name":"li si"}  # 服务器发送正确登录消息

{"msgid":6,"id":23,"from":"li si","toid":22,"msg":"中文 json 解析出错导致服务器挂掉"}  # 李四给张三发消息

```

## 离线消息 v0.8.6

```bash
# 服务端
$ ../bin/ChatServer
# 张三连接
20230609 05:54:23.216238Z  2985 INFO  TcpServer::newConnection [ChatServer] - new connection [ChatServer-127.0.0.1:6000#1] from 127.0.0.1:52198 - TcpServer.cc:80
{"msgid":1,"id":22,"password":"123456"}

20230609 05:54:46.894642Z  2986 INFO  connect mysql success! - db.cpp:28

# 张三登录
20230609 05:54:46.899854Z  2986 INFO  connect mysql success! - db.cpp:28
20230609 05:54:46.920720Z  2986 INFO  connect mysql success! - db.cpp:28

# 张三给李四发送离线消息
{"msgid":6,"id":22,"from":"zhang san","toid":23,"msg":"hello1"}

20230609 05:54:59.070956Z  2986 INFO  connect mysql success! - db.cpp:28
{"msgid":6,"id":22,"from":"zhang san","toid":23,"msg":"hello2"}

20230609 05:55:12.950222Z  2986 INFO  connect mysql success! - db.cpp:28

# 李四连接
20230609 05:55:12.950222Z  2986 INFO  connect mysql success! - db.cpp:28
20230609 05:58:28.158682Z  2985 INFO  TcpServer::newConnection [ChatServer] - new connection [ChatServer-127.0.0.1:6000#2] from 127.0.0.1:52212 - TcpServer.cc:80

# 李四de
{"msgid":1,"id":23,"password":"666666"}

20230609 05:59:03.904831Z  2987 INFO  connect mysql success! - db.cpp:28
20230609 05:59:03.909530Z  2987 INFO  connect mysql success! - db.cpp:28
20230609 05:59:03.933235Z  2987 INFO  connect mysql success! - db.cpp:28
20230609 05:59:03.940436Z  2987 INFO  connect mysql success! - db.cpp:28
```

```bash
# 客户端 张三
$ telnet 127.0.0.1 6000
{"msgid":1,"id":22,"password":"123456"}  # 张三登录
{"errno":0,"id":22,"msgid":2,"name":"zhang san"}  # 服务器发送正确登录消息

{"msgid":6,"id":22,"from":"zhang san","toid":23,"msg":"hello1"}  # 张三给李四发消息
{"msgid":6,"id":22,"from":"zhang san","toid":23,"msg":"hello2"}  # 张三给李四发消息
```

```bash
# 客户端 李四
$ telnet 127.0.0.1 6000
{"msgid":1,"id":23,"password":"666666"}  # 李四登录 

# 两个离线消息
```

```bash
# 数据库
mysql> update user set state = 'offline' where id=22;  # 手动将张三下线
mysql> update user set state = 'offline' where id=23;  # 手动将李四下线

mysql> select * from offlinemessage;  # 张三给李四发的离线消息
+--------+-----------------------------------------------------------------+
| userid | message                                                         |
+--------+-----------------------------------------------------------------+
|     23 | {"from":"zhang san","id":22,"msg":"hello1","msgid":6,"toid":23} |
|     23 | {"from":"zhang san","id":22,"msg":"hello2","msgid":6,"toid":23} |
+--------+-----------------------------------------------------------------+
2 rows in set (0.00 sec)

# 李四登录后，李四的离线消息被删除
mysql> select * from offlinemessage;
Empty set (0.00 sec)
```

## 服务端异常掉线 v0.8.7

## 添加好友 v0.8.8

```bash
# 服务端
```

```bash
# 客户端 张三
# 
{"msgid":1,"id":22,"password":"123456"}
{"msgid":7,"id":22,"friendid":23} # 添加李四为好友
# 推出后重新登录，返回好友列表
{"msgid":1,"id":22,"password":"123456"}
{"errno":0,"friends":["{\"id\":23,\"name\":\"li si\",\"state\":\"offline\"}"],"id":22,"msgid":2,"name":"zhang san"}
```

```bash
mysql> select * from friend;
+--------+----------+
| userid | friendid |
+--------+----------+
|     22 |       23 |
+--------+----------+
1 row in set (0.00 sec)

mysql> update user set state = 'offline' where id=22;  # 手动将其下线
```

## 群组业务 v0.8.9



